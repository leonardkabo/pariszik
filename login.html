<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParisZik - Connexion</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- Configuration et Initialisation -->
    <script src="js/config.js"></script>
    <script src="js/init.js"></script>
    <script src="js/firebase.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="logo">Paris<span>Zik</span></div>
                <h2>Se connecter</h2>
                <p>Connectez-vous pour accéder à tous les contenus de la plateforme</p>
                <div class="connection-status" id="connectionStatus">État de la connexion: Initialisation...</div>
            </div>
            
            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="votre@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Mot de passe</label>
                    <input type="password" id="password" placeholder="••••••••" required>
                </div>
                
                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="remember"> Se souvenir de moi
                    </label>
                    <a href="#" class="forgot-password">Mot de passe oublié ?</a>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">Se connecter</button>
            </form>
            
            <div class="auth-separator">
                <span>ou</span>
            </div>
            
            <div class="social-login">
                <button class="btn btn-secondary social-btn google-btn">
                    <span>Se connecter avec Google</span>
                </button>
            </div>
            
            <div class="auth-footer">
                <p>Pas encore de compte ? <a href="signup.html">S'inscrire</a></p>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-grid">
                <p>&copy; 2023 ParisZik. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Page de connexion chargée');
            
            const connectionStatus = document.getElementById('connectionStatus');
            const loginForm = document.getElementById('loginForm');
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            
            // Mettre à jour le statut de connexion
            function updateConnectionStatus(status, message) {
                if (connectionStatus) {
                    connectionStatus.textContent = message;
                    connectionStatus.className = 'connection-status ' + status;
                }
            }
            
            try {
                // Attendre l'initialisation de ParisZik
                await window.ParisZikInit.initializeFirebase();
                
                // Mettre à jour le statut
                const status = window.ParisZikInit.getStatus();
                if (status.isOnline) {
                    updateConnectionStatus('online', '✅ Connecté - Prêt à se connecter');
                } else {
                    updateConnectionStatus('offline', '⚠️ Mode offline - Certaines fonctionnalités peuvent être limitées');
                }
                
                console.log('Initialisation terminée:', status);
                
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                updateConnectionStatus('error', '❌ Erreur d\'initialisation - Veuillez rafraîchir la page');
            }
            
            // Gestion du formulaire de connexion
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                // Validation basique
                if (!email || !password) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }
                
                // Afficher un indicateur de chargement
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Connexion en cours...';
                submitBtn.disabled = true;
                
                try {
                    console.log('Tentative de connexion pour:', email);
                    
                    // Initialiser l'authentification si ce n'est pas déjà fait
                    if (!window.ParisZikAuth.initialized) {
                        await window.ParisZikAuth.initialize();
                    }
                    
                    // Utiliser l'authentification ParisZik
                    const result = await window.ParisZikAuth.signIn(email, password);
                    
                    if (result.success) {
                        console.log('Connexion réussie:', result.user.email);
                        
                        // Vérifier si l'utilisateur est admin (uniquement pour votre email)
                        let userRole = 'user';
                        
                        // Pour votre email spécifique, attribuer le rôle admin
                        if (email.toLowerCase() === 'leonardkabo32@gmail.com') {
                            userRole = 'admin';
                            
                            // Mettre à jour le rôle dans Firestore
                            try {
                                await window.ParisZikInit.getServices().db.collection("users").doc(result.user.uid).set({
                                    role: 'admin'
                                }, { merge: true });
                                console.log('Rôle admin attribué dans Firestore');
                            } catch (error) {
                                console.warn('Erreur lors de la mise à jour du rôle dans Firestore:', error);
                            }
                        } else {
                            // Pour les autres utilisateurs, vérifier le rôle dans Firestore
                            try {
                                const userDoc = await window.ParisZikInit.getServices().db.collection("users").doc(result.user.uid).get();
                                if (userDoc.exists) {
                                    const userData = userDoc.data();
                                    userRole = userData.role || 'user';
                                }
                            } catch (error) {
                                console.warn('Erreur lors de la vérification du rôle:', error);
                            }
                        }
                        
                        // Mettre à jour le localStorage
                        localStorage.setItem('userId', result.user.uid);
                        localStorage.setItem('userName', result.user.displayName || result.user.email.split('@')[0]);
                        localStorage.setItem('userRole', userRole);
                        
                        // Afficher un message de succès
                        if (userRole === 'admin') {
                            alert('Connexion réussie ! Bienvenue Administrateur.');
                        } else {
                            alert('Connexion réussie ! Bienvenue sur ParisZik.');
                        }
                        
                        // Rediriger vers la page d'accueil
                        window.location.href = 'index.html';
                    }
                } catch (error) {
                    console.error('Erreur de connexion:', error);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    
                    let errorMessage = 'Erreur de connexion: ';
                    switch (error.code) {
                        case 'auth/invalid-email':
                            errorMessage += 'Email invalide.';
                            break;
                        case 'auth/user-disabled':
                            errorMessage += 'Compte désactivé.';
                            break;
                        case 'auth/user-not-found':
                            errorMessage += 'Aucun compte associé à cet email.';
                            break;
                        case 'auth/wrong-password':
                            errorMessage += 'Mot de passe incorrect.';
                            break;
                        default:
                            errorMessage += error.message;
                    }
                    
                    alert(errorMessage);
                }
            });

            // Gestion du mot de passe oublié
            document.querySelector('.forgot-password').addEventListener('click', function(e) {
                e.preventDefault();
                
                const email = prompt('Veuillez entrer votre adresse email pour recevoir un lien de réinitialisation:');
                if (email) {
                    // Initialiser l'authentification si ce n'est pas déjà fait
                    if (!window.ParisZikAuth.initialized) {
                        window.ParisZikAuth.initialize().then(() => {
                            window.ParisZikAuth.resetPassword(email)
                                .then(() => {
                                    alert('Un email de réinitialisation a été envoyé à ' + email);
                                })
                                .catch((error) => {
                                    console.error('Erreur lors de l\'envoi de l\'email de réinitialisation:', error);
                                    alert('Erreur: ' + error.message);
                                });
                        });
                    } else {
                        window.ParisZikAuth.resetPassword(email)
                            .then(() => {
                                alert('Un email de réinitialisation a été envoyé à ' + email);
                            })
                            .catch((error) => {
                                console.error('Erreur lors de l\'envoi de l\'email de réinitialisation:', error);
                                alert('Erreur: ' + error.message);
                            });
                    }
                }
            });
            
            // Gestion de la connexion avec Google
            document.querySelector('.google-btn').addEventListener('click', async function() {
                try {
                    console.log('Tentative de connexion Google...');
                    
                    // Initialiser l'authentification si ce n'est pas déjà fait
                    if (!window.ParisZikAuth.initialized) {
                        await window.ParisZikAuth.initialize();
                    }
                    
                    // Utiliser l'authentification ParisZik
                    const result = await window.ParisZikAuth.signInWithGoogle();
                    
                    if (result.success) {
                        console.log('Connexion Google réussie:', result.user.email);
                        
                        // Vérifier si l'utilisateur est admin (uniquement pour votre email)
                        let userRole = 'user';
                        
                        // Pour votre email spécifique, attribuer le rôle admin
                        if (result.user.email.toLowerCase() === 'leonardkabo32@gmail.com') {
                            userRole = 'admin';
                            
                            // Mettre à jour le rôle dans Firestore
                            try {
                                await window.ParisZikInit.getServices().db.collection("users").doc(result.user.uid).set({
                                    role: 'admin'
                                }, { merge: true });
                                console.log('Rôle admin attribué dans Firestore');
                            } catch (error) {
                                console.warn('Erreur lors de la mise à jour du rôle dans Firestore:', error);
                            }
                        } else {
                            // Pour les autres utilisateurs, vérifier le rôle dans Firestore
                            try {
                                const userDoc = await window.ParisZikInit.getServices().db.collection("users").doc(result.user.uid).get();
                                if (userDoc.exists) {
                                    const userData = userDoc.data();
                                    userRole = userData.role || 'user';
                                }
                            } catch (error) {
                                console.warn('Erreur lors de la vérification du rôle:', error);
                            }
                        }
                        
                        // Mettre à jour le localStorage
                        localStorage.setItem('userId', result.user.uid);
                        localStorage.setItem('userName', result.user.displayName || result.user.email.split('@')[0]);
                        localStorage.setItem('userRole', userRole);
                        localStorage.setItem('userPhoto', result.user.photoURL || '');
                        
                        // Afficher un message de succès
                        if (userRole === 'admin') {
                            alert('Connexion Google réussie ! Bienvenue Administrateur.');
                        } else {
                            alert('Connexion Google réussie !');
                        }
                        
                        // Rediriger vers la page d'accueil
                        window.location.href = 'index.html';
                    }
                } catch (error) {
                    console.error('Erreur de connexion Google:', error);
                    alert('Erreur de connexion Google: ' + error.message + '\n\nEssayez en mode navigation privée ou avec un autre navigateur.');
                }
            });
        });
    </script>
    
    <style>
        .connection-status {
            margin: 1rem 0;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .connection-status.online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .connection-status.offline {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Animation de chargement */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        button[disabled] {
            animation: pulse 1.5s infinite;
        }
    </style>
</body>
</html>