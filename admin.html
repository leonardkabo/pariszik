<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParisZik - Administration</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">Paris<span>Zik</span> Admin</div>
            <nav>
                <ul>
                    <li><a href="index.html">Retour au site</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <button class="btn btn-secondary" id="logoutBtn">D√©connexion</button>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="admin-header">
                <h1>Panel d'Administration - ParisZik</h1>
                <p id="adminStatus">V√©rification des permissions...</p>
            </div>
            
            <div id="adminContent" style="display: none;">
                <div class="admin-section">
                    <h2>Ajouter un nouveau clip ou une diffusion en direct</h2>
                    <form id="uploadForm" class="admin-form">
                        <div class="form-group">
                            <label for="contentType">Type de contenu</label>
                            <select id="contentType" required>
                                <option value="">S√©lectionner un type</option>
                                <option value="audio">Audio</option>
                                <option value="video">Vid√©o</option>
                                <option value="live">Diffusion en direct</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="title">Titre</label>
                            <input type="text" id="title" placeholder="Titre du clip ou de l'√©v√©nement" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="artist">Artiste</label>
                            <input type="text" id="artist" placeholder="Nom de l'artiste" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" rows="3" placeholder="Description du contenu"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="category">Cat√©gorie</label>
                            <select id="category" required>
                                <option value="">S√©lectionner une cat√©gorie</option>
                                <option value="pop">Pop</option>
                                <option value="rock">Rock</option>
                                <option value="hiphop">Hip-Hop</option>
                                <option value="electro">√âlectro</option>
                                <option value="jazz">Jazz</option>
                                <option value="classical">Classique</option>
                                <option value="world">World</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="fileUpload" class="file-upload-label">
                                <input type="file" id="fileUpload" accept="audio/*,video/*">
                                <span>üìÅ Cliquez ici pour s√©lectionner un fichier</span>
                                <p>(MP3, MP4, MOV - Max 200MB pour le test)</p>
                            </label>
                        </div>
                        
                        <div id="uploadStatus" class="upload-status"></div>
                        
                        <button type="submit" class="btn btn-primary">Uploader vers MEGA et publier</button>
                    </form>
                </div>
                
                <div class="admin-section">
                    <h2>Contenus existants</h2>
                    <div class="admin-content-grid" id="existingContent">
                        <!-- Contenu g√©n√©r√© dynamiquement -->
                    </div>
                </div>
            </div>
            
            <div id="accessDenied" style="display: none;">
                <div class="warning" style="padding: 2rem; text-align: center;">
                    <h3>‚õî Acc√®s refus√©</h3>
                    <p>Vous n'avez pas les permissions n√©cessaires pour acc√©der √† cette page.</p>
                    <p>Seuls les administrateurs peuvent acc√©der au panel d'administration.</p>
                    <a href="index.html" class="btn btn-primary" style="margin-top: 1rem;">Retour √† l'accueil</a>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-grid">
                <p>&copy; 2023 ParisZik - Panel d'Administration</p>
            </div>
        </div>
    </footer>

    <script src="js/firebase.js"></script>
    <script src="js/mega.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCLziaBhKhyr1Jz8C4mRt5vYMEWmxoUsxQ",
            authDomain: "pariszik-6ced1.firebaseapp.com",
            projectId: "pariszik-6ced1",
            storageBucket: "pariszik-6ced1.firebasestorage.app",
            messagingSenderId: "1065971112198",
            appId: "1:1065971112198:web:d997951efedb2c6bc3a687"
        };
        
        // Initialiser Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // √âl√©ments du DOM
        const adminStatus = document.getElementById('adminStatus');
        const adminContent = document.getElementById('adminContent');
        const accessDenied = document.getElementById('accessDenied');
        const logoutBtn = document.getElementById('logoutBtn');
        const uploadForm = document.getElementById('uploadForm');
        const fileUpload = document.getElementById('fileUpload');
        const fileLabel = document.querySelector('.file-upload-label span');
        const uploadStatus = document.getElementById('uploadStatus');
        const existingContent = document.getElementById('existingContent');
        
        // V√©rifier l'authentification et les permissions
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                // V√©rifier si l'utilisateur est admin
                const db = firebase.firestore();
                db.collection("users").doc(user.uid).get()
                    .then((doc) => {
                        if (doc.exists && doc.data().role === 'admin') {
                            adminStatus.textContent = '‚úÖ Acc√®s autoris√© - Bienvenue administrateur';
                            adminStatus.style.color = '#28a745';
                            adminContent.style.display = 'block';
                            initializeAdminPage();
                        } else {
                            adminStatus.textContent = '‚õî Acc√®s refus√©';
                            adminStatus.style.color = '#dc3545';
                            accessDenied.style.display = 'block';
                        }
                    })
                    .catch((error) => {
                        console.error('Erreur lors de la v√©rification des permissions:', error);
                        adminStatus.textContent = '‚ùå Erreur de v√©rification des permissions';
                        adminStatus.style.color = '#dc3545';
                        accessDenied.style.display = 'block';
                    });
            } else {
                // Rediriger vers la page de connexion
                window.location.href = 'login.html';
            }
        });
        
        // Gestion de la d√©connexion
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                firebase.auth().signOut()
                    .then(() => {
                        console.log('D√©connexion r√©ussie');
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userName');
                        localStorage.removeItem('userRole');
                        localStorage.removeItem('userPhoto');
                        window.location.href = 'index.html';
                    })
                    .catch((error) => {
                        console.error('Erreur lors de la d√©connexion:', error);
                        alert('Erreur lors de la d√©connexion: ' + error.message);
                    });
            });
        }
        
        // Initialiser la page d'administration
        function initializeAdminPage() {
            // Initialiser MEGA
            if (window.ParisZikMega && window.ParisZikMega.initializeForAdmin) {
                window.ParisZikMega.initializeForAdmin().then(success => {
                    if (success) {
                        console.log('MEGA initialis√© avec succ√®s');
                    } else {
                        console.warn('√âchec de l\'initialisation de MEGA - fonctionnalit√©s limit√©es');
                    }
                });
            }
            
            // Charger les contenus existants depuis Firestore
            loadExistingContent();
            
            // Gestion du formulaire d'upload
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const contentType = document.getElementById('contentType').value;
                const title = document.getElementById('title').value;
                const artist = document.getElementById('artist').value;
                const file = fileUpload.files[0];
                
                if (!contentType || !title || !artist) {
                    uploadStatus.textContent = 'Veuillez remplir tous les champs obligatoires.';
                    uploadStatus.className = 'upload-status error';
                    uploadStatus.style.display = 'block';
                    return;
                }
                
                if (!file) {
                    uploadStatus.textContent = 'Veuillez s√©lectionner un fichier √† uploader.';
                    uploadStatus.className = 'upload-status error';
                    uploadStatus.style.display = 'block';
                    return;
                }
                
                // V√©rifier la taille du fichier (max 200MB pour le test)
                if (file.size > 200 * 1024 * 1024) {
                    uploadStatus.textContent = 'Le fichier est trop volumineux (max 200MB).';
                    uploadStatus.className = 'upload-status error';
                    uploadStatus.style.display = 'block';
                    return;
                }
                
                // Simuler l'upload vers MEGA
                uploadStatus.textContent = 'Upload en cours vers MEGA...';
                uploadStatus.className = 'upload-status success';
                uploadStatus.style.display = 'block';
                
                // D√©sactiver le bouton pendant l'upload
                const submitBtn = uploadForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Upload en cours...';
                submitBtn.disabled = true;
                
                setTimeout(() => {
                    // Simuler le succ√®s de l'upload
                    const fileUrl = `https://mega.nz/file/${Date.now()}`;
                    
                    // Enregistrer le contenu dans Firestore
                    const db = firebase.firestore();
                    const contentData = {
                        title: title,
                        artist: artist,
                        description: document.getElementById('description').value,
                        category: document.getElementById('category').value,
                        contentType: contentType,
                        fileUrl: fileUrl,
                        fileName: file.name,
                        fileSize: file.size,
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        uploadedBy: firebase.auth().currentUser.uid,
                        views: 0,
                        likes: 0,
                        isLive: contentType === 'live'
                    };
                    
                    db.collection("contents").add(contentData)
                        .then((docRef) => {
                            uploadStatus.textContent = `‚úÖ Upload r√©ussi ! ${title} par ${artist} a √©t√© publi√© sur ParisZik.`;
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                            
                            // Ajouter le nouveau contenu √† la liste
                            addContentToGrid({
                                id: docRef.id,
                                ...contentData
                            });
                            
                            // R√©initialiser le formulaire
                            uploadForm.reset();
                            fileLabel.textContent = 'üìÅ Cliquez ici pour s√©lectionner un fichier';
                        })
                        .catch((error) => {
                            console.error('Erreur lors de l\'enregistrement du contenu:', error);
                            uploadStatus.textContent = `‚ùå Erreur lors de la publication: ${error.message}`;
                            uploadStatus.className = 'upload-status error';
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        });
                }, 2000);
            });
            
            // Gestion du label de fichier
            fileUpload.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileLabel.textContent = this.files[0].name;
                }
            });
        }
        
        // Charger les contenus existants depuis Firestore
        function loadExistingContent() {
            const db = firebase.firestore();
            const contentsRef = db.collection("contents").orderBy("uploadedAt", "desc");
            
            contentsRef.get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        // Ajouter du contenu par d√©faut si la collection est vide
                        addDefaultContent();
                    } else {
                        querySnapshot.forEach((doc) => {
                            addContentToGrid({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                    }
                })
                .catch((error) => {
                    console.error('Erreur lors du chargement des contenus:', error);
                    // Ajouter du contenu par d√©faut en cas d'erreur
                    addDefaultContent();
                });
        }
        
        // Ajouter du contenu par d√©faut
        function addDefaultContent() {
            const defaultContent = [
                { 
                    title: "Summer Vibes", 
                    artist: "Artiste International", 
                    contentType: "Audio", 
                    category: "Pop", 
                    uploadedAt: new Date(), 
                    views: 2500000, 
                    likes: 45000,
                    isLive: false
                },
                { 
                    title: "Concert Paris", 
                    artist: "Artiste Populaire", 
                    contentType: "Live", 
                    category: "√âlectro", 
                    uploadedAt: new Date(Date.now() - 86400000), 
                    views: 15432,
                    likes: 2345,
                    isLive: true
                },
                { 
                    title: "Midnight Dreams", 
                    artist: "Nouvel Artiste", 
                    contentType: "Vid√©o", 
                    category: "Hip-Hop", 
                    uploadedAt: new Date(Date.now() - 172800000), 
                    views: 876543,
                    likes: 12345,
                    isLive: false
                }
            ];
            
            defaultContent.forEach(item => {
                addContentToGrid(item);
            });
        }
        
        // Ajouter un contenu √† la grille
        function addContentToGrid(content) {
            const card = document.createElement('div');
            card.className = 'admin-card';
            card.dataset.id = content.id || 'default';
            
            // Formater la date
            const date = content.uploadedAt?.toDate ? content.uploadedAt.toDate() : content.uploadedAt;
            const formattedDate = date ? new Date(date).toLocaleDateString('fr-FR') : 'Date inconnue';
            
            card.innerHTML = `
                <div class="admin-card-header">
                    <span>${content.title}</span>
                    <span>${content.contentType}</span>
                </div>
                <div class="card-content">
                    <p class="card-artist">${content.artist}</p>
                    <p>Cat√©gorie: ${content.category}</p>
                    <p>Date: ${formattedDate}</p>
                    <p>Vues: ${content.views || 0} | Likes: ${content.likes || 0}</p>
                </div>
                <div class="admin-card-actions">
                    <button class="btn btn-view" data-id="${content.id || 'default'}">Voir</button>
                    <button class="btn btn-edit" data-id="${content.id || 'default'}">Modifier</button>
                    <button class="btn btn-delete" data-id="${content.id || 'default'}">Supprimer</button>
                </div>
            `;
            existingContent.appendChild(card);
            
            // Ajouter les gestionnaires d'√©v√©nements
            addAdminEventListeners();
        }
        
        // Fonction pour ajouter les gestionnaires d'√©v√©nements aux boutons d'administration
        function addAdminEventListeners() {
            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    alert('Visualisation du contenu avec ID: ' + id);
                });
            });
            
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    alert('Modification du contenu avec ID: ' + id);
                    // Ici, vous pouvez ouvrir un modal ou rediriger vers une page d'√©dition
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    if (confirm('√ätes-vous s√ªr de vouloir supprimer ce contenu ?')) {
                        // Supprimer le contenu de Firestore
                        const db = firebase.firestore();
                        db.collection("contents").doc(id).delete()
                            .then(() => {
                                console.log('Contenu supprim√© avec succ√®s');
                                this.closest('.admin-card').remove();
                                alert('Contenu supprim√© avec succ√®s');
                            })
                            .catch((error) => {
                                console.error('Erreur lors de la suppression du contenu:', error);
                                alert('Erreur lors de la suppression: ' + error.message);
                            });
                    }
                });
            });
        }
    </script>
</body>
</html>