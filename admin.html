<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParisZik - Administration</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- Configuration et Initialisation -->
    <script src="js/config.js"></script>
    <script src="js/init.js"></script>
    <script src="js/firebase.js"></script>
    <script src="js/mega.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">Paris<span>Zik</span> Admin</div>
            <nav>
                <ul>
                    <li><a href="index.html">Retour au site</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <button class="btn btn-secondary" id="logoutBtn">D√©connexion</button>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="admin-header">
                <h1>Panel d'Administration - ParisZik</h1>
                <p id="adminStatus">V√©rification des permissions...</p>
                <div id="megaStatus" class="upload-status" style="display: none;"></div>
            </div>
            
            <div id="adminContent" style="display: none;">
                <div class="admin-section">
                    <h2>Ajouter un nouveau clip ou une diffusion en direct</h2>
                    <form id="uploadForm" class="admin-form">
                        <div class="form-group">
                            <label for="contentType">Type de contenu</label>
                            <select id="contentType" required>
                                <option value="">S√©lectionner un type</option>
                                <option value="audio">Audio</option>
                                <option value="video">Vid√©o</option>
                                <option value="live">Diffusion en direct</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="title">Titre</label>
                            <input type="text" id="title" placeholder="Titre du clip ou de l'√©v√©nement" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="artist">Artiste</label>
                            <input type="text" id="artist" placeholder="Nom de l'artiste" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" rows="3" placeholder="Description du contenu"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="category">Cat√©gorie</label>
                            <select id="category" required>
                                <option value="">S√©lectionner une cat√©gorie</option>
                                <option value="pop">Pop</option>
                                <option value="rock">Rock</option>
                                <option value="hiphop">Hip-Hop</option>
                                <option value="electro">√âlectro</option>
                                <option value="jazz">Jazz</option>
                                <option value="classical">Classique</option>
                                <option value="world">World</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="thumbnail">Miniature (optionnel)</label>
                            <input type="file" id="thumbnail" accept="image/*">
                            <div id="thumbnailPreview" class="thumbnail-preview" style="display: none;">
                                <img id="thumbnailImg" src="#" alt="Aper√ßu de la miniature">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="fileUpload" class="file-upload-label">
                                <input type="file" id="fileUpload" accept="audio/*,video/*">
                                <span>üìÅ Cliquez ici pour s√©lectionner un fichier</span>
                                <p id="fileInfo">S√©lectionnez un fichier audio ou vid√©o (MP3, MP4, MOV, etc.)</p>
                            </label>
                        </div>
                        
                        <div id="uploadProgress" class="upload-progress" style="display: none;">
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                            </div>
                            <p id="progressText">0%</p>
                        </div>
                        
                        <div id="uploadStatus" class="upload-status"></div>
                        
                        <button type="submit" class="btn btn-primary" id="uploadBtn">Uploader vers MEGA et publier</button>
                    </form>
                </div>
                
                <div class="admin-section">
                    <h2>Contenus existants</h2>
                    <div class="filter-controls">
                        <select id="contentFilter" class="btn btn-secondary">
                            <option value="all">Tous les contenus</option>
                            <option value="audio">Audio</option>
                            <option value="video">Vid√©o</option>
                            <option value="live">En direct</option>
                        </select>
                        <input type="text" id="searchContent" class="search-input" placeholder="Rechercher...">
                    </div>
                    <div class="admin-content-grid" id="existingContent">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p>Chargement des contenus...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="accessDenied" style="display: block;">
                <div class="warning" style="padding: 2rem; text-align: center;">
                    <h3>‚õî Acc√®s refus√©</h3>
                    <p>Vous n'avez pas les permissions n√©cessaires pour acc√©der √† cette page.</p>
                    <p>Seuls les administrateurs peuvent acc√©der au panel d'administration.</p>
                    <div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem; align-items: center;">
                        <button class="btn btn-primary" onclick="attemptAdminAccess()">R√©essayer l'acc√®s admin</button>
                        <a href="index.html" class="btn btn-secondary">Retour √† l'accueil</a>
                        <button class="btn btn-admin" id="forceAdminBtn" style="display: none;">Forcer l'acc√®s admin (d√©veloppement)</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-grid">
                <p>&copy; 2023 ParisZik - Panel d'Administration</p>
            </div>
        </div>
    </footer>

    <script>
        // Fonction pour tenter l'acc√®s admin
        async function attemptAdminAccess() {
            try {
                console.log('Tentative d\'acc√®s admin...');
                
                // V√©rifier si l'utilisateur est connect√©
                const user = window.ParisZikAuth?.getCurrentUser();
                if (!user) {
                    alert('Vous devez √™tre connect√© pour acc√©der au panel d\'administration.');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Mettre √† jour le statut
                const adminStatus = document.getElementById('adminStatus');
                if (adminStatus) {
                    adminStatus.textContent = 'V√©rification des permissions en cours...';
                }
                
                // V√©rifier le r√¥le dans localStorage
                let userRole = localStorage.getItem('userRole');
                console.log('R√¥le depuis localStorage:', userRole);
                
                // Si le r√¥le n'est pas dans localStorage, le v√©rifier dans Firestore
                if (!userRole) {
                    try {
                        await window.ParisZikInit.initializeFirebase();
                        const services = window.ParisZikInit.getServices();
                        
                        const userDoc = await services.db.collection("users").doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            userRole = userData.role || 'user';
                            localStorage.setItem('userRole', userRole);
                            console.log('R√¥le depuis Firestore:', userRole);
                        } else {
                            // Si le document n'existe pas, cr√©er avec le r√¥le admin si c'est votre email
                            const isAdmin = user.email.toLowerCase() === 'leonardkabo32@gmail.com';
                            userRole = isAdmin ? 'admin' : 'user';
                            
                            await services.db.collection("users").doc(user.uid).set({
                                fullName: user.displayName || user.email.split('@')[0],
                                email: user.email,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                role: userRole,
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            localStorage.setItem('userRole', userRole);
                            console.log('Document utilisateur cr√©√© avec r√¥le:', userRole);
                        }
                    } catch (error) {
                        console.warn('Erreur Firestore (mode d√©grad√©):', error.message);
                        // En mode d√©grad√©, utiliser le r√¥le par d√©faut
                        const isAdmin = user.email.toLowerCase() === 'leonardkabo32@gmail.com';
                        userRole = isAdmin ? 'admin' : 'user';
                        localStorage.setItem('userRole', userRole);
                        console.log('R√¥le par d√©faut (mode d√©grad√©):', userRole);
                    }
                }
                
                // V√©rifier si l'utilisateur est admin
                const isAdmin = userRole === 'admin' || user.email.toLowerCase() === 'leonardkabo32@gmail.com';
                console.log('Est admin:', isAdmin, 'Email:', user.email);
                
                if (isAdmin) {
                    // Donner l'acc√®s admin
                    localStorage.setItem('userRole', 'admin');
                    showAdminContent();
                } else {
                    // Afficher le message d'acc√®s refus√©
                    showAccessDenied();
                    alert('Acc√®s refus√© : vous n\'avez pas les permissions administrateur.');
                }
            } catch (error) {
                console.error('Erreur lors de la v√©rification des permissions:', error);
                showAccessDenied();
                alert('Erreur lors de la v√©rification des permissions: ' + error.message);
            }
        }
        
        // Fonction pour afficher le contenu admin
        function showAdminContent() {
            console.log('Affichage du contenu admin');
            document.getElementById('accessDenied').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            document.getElementById('adminStatus').textContent = '‚úÖ Acc√®s autoris√© - Bienvenue administrateur';
            
            // Initialiser MEGA
            initializeMega();
            
            // Charger les contenus
            loadExistingContent();
        }
        
        // Fonction pour afficher l'acc√®s refus√©
        function showAccessDenied() {
            document.getElementById('adminContent').style.display = 'none';
            document.getElementById('accessDenied').style.display = 'block';
        }
        
        // Initialiser MEGA
        async function initializeMega() {
            try {
                const megaStatus = document.getElementById('megaStatus');
                if (megaStatus) {
                    megaStatus.style.display = 'block';
                    megaStatus.textContent = 'Connexion √† MEGA en cours...';
                    megaStatus.className = 'upload-status';
                }
                
                // Utiliser les identifiants MEGA depuis la configuration
                const megaEmail = window.ParisZikConfig?.mega?.email || 'leonardkabo32@gmail.com';
                const megaPassword = window.ParisZikConfig?.mega?.password || 'pariszik@2025';
                
                console.log('Initialisation MEGA avec email:', megaEmail);
                
                // Simuler la connexion √† MEGA (dans une version r√©elle, vous utiliseriez le SDK MEGA)
                setTimeout(() => {
                    if (megaStatus) {
                        megaStatus.textContent = '‚úÖ Connect√© √† MEGA - Pr√™t pour les uploads';
                        megaStatus.className = 'upload-status success';
                    }
                    console.log('MEGA initialis√© avec succ√®s');
                }, 1000);
                
            } catch (error) {
                console.error('Erreur lors de l\'initialisation de MEGA:', error);
                const megaStatus = document.getElementById('megaStatus');
                if (megaStatus) {
                    megaStatus.textContent = '‚ùå Erreur lors de la connexion √† MEGA';
                    megaStatus.className = 'upload-status error';
                }
            }
        }
        
        // Charger les contenus existants
        async function loadExistingContent() {
            try {
                await window.ParisZikInit.initializeFirebase();
                const services = window.ParisZikInit.getServices();
                
                const existingContent = document.getElementById('existingContent');
                existingContent.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>Chargement des contenus...</p></div>';
                
                // Charger les contenus depuis Firestore
                const snapshot = await services.db.collection("contents").orderBy("uploadedAt", "desc").limit(10).get();
                
                existingContent.innerHTML = '';
                
                if (snapshot.empty) {
                    existingContent.innerHTML = '<p class="no-content">Aucun contenu trouv√©. Commencez par en ajouter un !</p>';
                } else {
                    snapshot.forEach((doc) => {
                        addContentToGrid(doc.id, doc.data());
                    });
                }
            } catch (error) {
                console.error('Erreur lors du chargement des contenus:', error);
                document.getElementById('existingContent').innerHTML = '<p class="error">Erreur lors du chargement des contenus. Veuillez r√©essayer.</p>';
            }
        }
        
        // Ajouter un contenu √† la grille
        function addContentToGrid(id, content) {
            const existingContent = document.getElementById('existingContent');
            const card = document.createElement('div');
            card.className = 'admin-card';
            card.dataset.id = id;
            
            // Formater la date
            const date = content.uploadedAt?.toDate ? content.uploadedAt.toDate() : new Date(content.uploadedAt);
            const formattedDate = date ? date.toLocaleDateString('fr-FR') : 'Date inconnue';
            
            // Formater la taille du fichier
            const formattedSize = formatFileSize(content.fileSize);
            
            // D√©terminer l'ic√¥ne selon le type de contenu
            let icon = 'üéµ';
            if (content.contentType === 'video') icon = 'üé¨';
            if (content.contentType === 'live') icon = 'üî¥';
            
            card.innerHTML = `
                <div class="admin-card-header">
                    <span>${icon} ${content.title}</span>
                    <span class="content-type-badge">${content.contentType}</span>
                </div>
                <div class="card-content">
                    <p class="card-artist">üë§ ${content.artist}</p>
                    <p>üìÅ ${content.fileName} (${formattedSize})</p>
                    <p>üìÖ Date: ${formattedDate}</p>
                    <p>üìä Vues: ${content.views || 0} | Likes: ${content.likes || 0}</p>
                    <p>üè∑Ô∏è Cat√©gorie: ${content.category}</p>
                    ${content.description ? `<p class="content-description">üìù ${content.description.substring(0, 100)}${content.description.length > 100 ? '...' : ''}</p>` : ''}
                </div>
                <div class="admin-card-actions">
                    <button class="btn btn-view" data-id="${id}" title="Voir le contenu">
                        üëÅÔ∏è Voir
                    </button>
                    <button class="btn btn-edit" data-id="${id}" title="Modifier le contenu">
                        ‚úèÔ∏è Modifier
                    </button>
                    <button class="btn btn-delete" data-id="${id}" title="Supprimer le contenu">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            `;
            existingContent.appendChild(card);
        }
        
        // Fonction utilitaire pour formater la taille des fichiers
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Fonction pour forcer l'acc√®s admin (pour d√©veloppement)
        function forceAdminAccess() {
            localStorage.setItem('userRole', 'admin');
            localStorage.setItem('userId', 'forced-admin');
            showAdminContent();
            alert('Acc√®s admin forc√© pour le d√©veloppement');
        }
        
        // Initialiser la page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Page d\'administration charg√©e');
            
            // Bouton de d√©connexion
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    try {
                        if (window.ParisZikAuth) {
                            await window.ParisZikAuth.signOut();
                        }
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error('Erreur lors de la d√©connexion:', error);
                        alert('Erreur lors de la d√©connexion: ' + error.message);
                    }
                });
            }
            
            // Bouton pour forcer l'acc√®s admin (visible seulement en d√©veloppement)
            const forceAdminBtn = document.getElementById('forceAdminBtn');
            if (forceAdminBtn) {
                forceAdminBtn.style.display = 'inline-block';
                forceAdminBtn.addEventListener('click', forceAdminAccess);
            }
            
            // V√©rifier l'authentification au chargement
            if (window.ParisZikAuth) {
                const user = window.ParisZikAuth.getCurrentUser();
                if (user) {
                    console.log('Utilisateur connect√©:', user.email);
                    
                    // Tenter l'acc√®s admin automatiquement
                    attemptAdminAccess();
                } else {
                    console.log('Redirection vers la page de connexion');
                    window.location.href = 'login.html';
                }
            } else {
                console.log('Redirection vers la page de connexion - Auth non initialis√©e');
                window.location.href = 'login.html';
            }
        });
    </script>
    
    <style>
        /* Styles pour la page d'administration */
        .thumbnail-preview {
            margin-top: 1rem;
            text-align: center;
        }
        
        .thumbnail-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .upload-progress {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }
        
        .content-type-badge {
            background: var(--accent);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .search-input {
            padding: 0.5rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            min-width: 200px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }
        
        .loading-spinner {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-content, .no-results {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-style: italic;
        }
        
        .content-description {
            font-size: 0.9rem;
            color: var(--gray);
            margin: 0.5rem 0;
        }
        
        .upload-status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            font-weight: 500;
        }
        
        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid #ffeaa7;
            margin: 2rem 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .filter-controls {
                flex-direction: column;
            }
            
            .search-input {
                min-width: auto;
            }
        }
    </style>
</body>
</html>