<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParisZik - D√©couvrez la musique du monde entier</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="js/firebase-init.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo">Paris<span>Zik</span></div>
            
            <!-- Menu hamburger pour mobile -->
            <button class="hamburger" id="hamburgerBtn">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <nav id="mainNav">
                <ul>
                    <li><a href="index.html" class="active">Accueil</a></li>
                    <li><a href="library.html">Biblioth√®que</a></li>
                    <li><a href="live.html">En Direct</a></li>
                    <li><a href="#">Clips</a></li>
                    <li><a href="#">Artistes</a></li>
                </ul>
            </nav>
            
            <div class="auth-buttons">
                <a href="login.html" class="btn btn-secondary" id="loginBtn">Se connecter</a>
                <a href="signup.html" class="btn btn-primary" id="signupBtn">S'inscrire</a>
                <a href="admin.html" class="btn btn-admin" id="adminBtn" style="display: none;">Admin</a>
                <div class="user-menu" id="userMenu" style="display: none;">
                    <span id="userName">Utilisateur</span>
                    <button class="btn btn-secondary" id="logoutBtn">D√©connexion</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar pour desktop -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>ParisZik</h3>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="index.html" class="active">Accueil</a></li>
                <li><a href="library.html">Biblioth√®que</a></li>
                <li><a href="favorites.html">Favoris</a></li>
                <li><a href="recent.html">Derniers ajouts</a></li>
                <li><a href="playlists.html">Playlists</a></li>
                <li><a href="artists.html">Artistes</a></li>
                <li><a href="categories.html">Cat√©gories</a></li>
                <li><a href="live.html">En Direct</a></li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="sidebarUserAvatar">üë§</div>
                <div class="user-details">
                    <div class="user-name" id="sidebarUserName">Utilisateur</div>
                    <div class="user-role" id="sidebarUserRole">Membre</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay pour mobile -->
    <div class="overlay" id="overlay"></div>

    <main>
        <section class="hero">
            <div class="container">
                <h1>ParisZik</h1>
                <p>La plateforme de streaming musical qui vous connecte aux artistes du monde entier et aux √©v√©nements en direct</p>
                <div class="search-bar">
                    <input type="text" placeholder="Rechercher un artiste, un titre, un album...">
                    <button>Rechercher</button>
                </div>
            </div>
        </section>

        <div class="tabs">
            <div class="container">
                <div class="tab active" data-tab="popular">Populaire</div>
                <div class="tab" data-tab="new">Nouveaut√©s</div>
                <div class="tab" data-tab="live">En Direct</div>
                <div class="tab" data-tab="playlists">Playlists</div>
            </div>
        </div>

        <section class="content-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Derniers clips ajout√©s</h2>
                    <a href="library.html" class="view-more-btn">Voir plus ‚Üí</a>
                </div>
                <div class="content-grid" id="recentContent">
                    <!-- Les 3 derniers clips seront affich√©s ici -->
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Chargement des derniers clips...</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="content-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">En ce moment</h2>
                    <a href="trending.html" class="view-more-btn">Voir plus ‚Üí</a>
                </div>
                <div class="content-grid" id="popularContent">
                    <!-- Contenu populaire -->
                </div>
            </div>
        </section>

        <section class="content-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">√âv√©nements en direct</h2>
                    <a href="live.html" class="view-more-btn">Voir plus ‚Üí</a>
                </div>
                <div class="content-grid" id="liveContent">
                    <!-- √âv√©nements en direct -->
                </div>
            </div>
        </section>

        <div class="player">
            <div class="container">
                <div class="player-container">
                    <img src="assets/images/placeholder.jpg" alt="Now Playing" class="player-img">
                    <div class="player-info">
                        <h4 class="player-title">Aucun titre en lecture</h4>
                        <p class="player-artist">-</p>
                    </div>
                    <div class="player-controls">
                        <button class="control-btn">‚èÆ</button>
                        <button class="control-btn">‚èØ</button>
                        <button class="control-btn">‚è≠</button>
                    </div>
                    <div class="progress">
                        <div class="progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-section">
                    <h3>ParisZik</h3>
                    <p>La plateforme de streaming musical qui vous connecte aux artistes du monde entier et aux √©v√©nements en direct.</p>
                    <div class="admin-access">
                        <a href="admin-access.html" class="admin-link">acc√®s admin</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Liens Rapides</h3>
                    <ul class="footer-links">
                        <li><a href="index.html">Accueil</a></li>
                        <li><a href="library.html">Biblioth√®que</a></li>
                        <li><a href="live.html">En Direct</a></li>
                        <li><a href="categories.html">Cat√©gories</a></li>
                        <li><a href="artists.html">Artistes</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>L√©gal</h3>
                    <ul class="footer-links">
                        <li><a href="#">Mentions L√©gales</a></li>
                        <li><a href="#">Politique de Confidentialit√©</a></li>
                        <li><a href="#">Conditions d'Utilisation</a></li>
                        <li><a href="#">Cookies</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <ul class="footer-links">
                        <li><a href="#">Support</a></li>
                        <li><a href="#">Nous √©crire</a></li>
                        <li><a href="#">Carri√®res</a></li>
                        <li><a href="#">Partenariats</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                &copy; 2023 ParisZik. Tous droits r√©serv√©s.
            </div>
        </div>
    </footer>

    <script src="js/firebase.js"></script>
    <script src="js/content.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCLziaBhKhyr1Jz8C4mRt5vYMEWmxoUsxQ",
            authDomain: "pariszik-6ced1.firebaseapp.com",
            projectId: "pariszik-6ced1",
            storageBucket: "pariszik-6ced1.firebasestorage.app",
            messagingSenderId: "1065971112198",
            appId: "1:1065971112198:web:d997951efedb2c6bc3a687"
        };
        
        // Initialiser Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // √âl√©ments du DOM
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const adminBtn = document.getElementById('adminBtn');
        const userMenu = document.getElementById('userMenu');
        const userName = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const sidebar = document.getElementById('sidebar');
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const overlay = document.getElementById('overlay');
        const sidebarUserName = document.getElementById('sidebarUserName');
        const sidebarUserRole = document.getElementById('sidebarUserRole');
        const sidebarUserAvatar = document.getElementById('sidebarUserAvatar');
        const recentContent = document.getElementById('recentContent');
        const popularContent = document.getElementById('popularContent');
        const liveContent = document.getElementById('liveContent');
        
        // Variables globales
        let currentUser = null;
        
        // V√©rifier l'√©tat d'authentification
        firebase.auth().onAuthStateChanged((user) => {
            currentUser = user;
            updateUIBasedOnAuth(user);
        });
        
        // Mettre √† jour l'interface utilisateur selon l'√©tat d'authentification
        function updateUIBasedOnAuth(user) {
            if (user) {
                // Utilisateur connect√©
                loginBtn.style.display = 'none';
                signupBtn.style.display = 'none';
                
                // R√©cup√©rer les informations de l'utilisateur depuis Firestore
                const db = firebase.firestore();
                db.collection("users").doc(user.uid).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            const userFullName = userData.fullName || user.email.split('@')[0];
                            const userRole = userData.role || 'user';
                            
                            // Mettre √† jour l'interface
                            userName.textContent = userFullName;
                            sidebarUserName.textContent = userFullName;
                            sidebarUserRole.textContent = userRole === 'admin' ? 'Administrateur' : 'Membre';
                            sidebarUserAvatar.textContent = userFullName.substring(0, 1).toUpperCase();
                            
                            // Afficher le menu utilisateur
                            userMenu.style.display = 'flex';
                            userMenu.style.alignItems = 'center';
                            userMenu.style.gap = '10px';
                            
                            // Afficher le bouton admin si l'utilisateur est admin
                            if (userRole === 'admin') {
                                adminBtn.style.display = 'inline-block';
                            } else {
                                adminBtn.style.display = 'none';
                            }
                        } else {
                            // Cr√©er un document utilisateur par d√©faut
                            const defaultUserData = {
                                fullName: user.email.split('@')[0],
                                email: user.email,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                role: "user"
                            };
                            
                            db.collection("users").doc(user.uid).set(defaultUserData)
                                .then(() => {
                                    userName.textContent = user.email.split('@')[0];
                                    sidebarUserName.textContent = user.email.split('@')[0];
                                    sidebarUserRole.textContent = 'Membre';
                                    sidebarUserAvatar.textContent = user.email.substring(0, 1).toUpperCase();
                                    
                                    userMenu.style.display = 'flex';
                                    userMenu.style.alignItems = 'center';
                                    userMenu.style.gap = '10px';
                                    adminBtn.style.display = 'none';
                                });
                        }
                    })
                    .catch((error) => {
                        console.error('Erreur lors de la r√©cup√©ration des donn√©es utilisateur:', error);
                        userName.textContent = user.email.split('@')[0];
                        sidebarUserName.textContent = user.email.split('@')[0];
                        sidebarUserRole.textContent = 'Membre';
                        sidebarUserAvatar.textContent = user.email.substring(0, 1).toUpperCase();
                        
                        userMenu.style.display = 'flex';
                        userMenu.style.alignItems = 'center';
                        userMenu.style.gap = '10px';
                        adminBtn.style.display = 'none';
                    });
            } else {
                // Utilisateur non connect√©
                loginBtn.style.display = 'inline-block';
                signupBtn.style.display = 'inline-block';
                adminBtn.style.display = 'none';
                userMenu.style.display = 'none';
                sidebarUserName.textContent = 'Invit√©';
                sidebarUserRole.textContent = 'Visiteur';
                sidebarUserAvatar.textContent = 'üë§';
            }
            
            // Charger les contenus apr√®s avoir mis √† jour l'interface
            loadContent();
        }
        
        // Gestion de la d√©connexion
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                firebase.auth().signOut()
                    .then(() => {
                        console.log('D√©connexion r√©ussie');
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userName');
                        localStorage.removeItem('userRole');
                        localStorage.removeItem('userPhoto');
                        window.location.reload();
                    })
                    .catch((error) => {
                        console.error('Erreur lors de la d√©connexion:', error);
                        alert('Erreur lors de la d√©connexion: ' + error.message);
                    });
            });
        }
        
        // Gestion du menu hamburger
        if (hamburgerBtn && overlay) {
            hamburgerBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                hamburgerBtn.classList.toggle('active');
                document.body.classList.toggle('no-scroll');
            });
            
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                hamburgerBtn.classList.remove('active');
                document.body.classList.remove('no-scroll');
            });
        }
        
        // Charger les contenus
        async function loadContent() {
            try {
                // Charger les 3 derniers clips
                await loadRecentContent();
                
                // Charger les contenus populaires
                await loadPopularContent();
                
                // Charger les contenus en direct
                await loadLiveContent();
                
            } catch (error) {
                console.error('Erreur lors du chargement des contenus:', error);
            }
        }
        
        // Charger les 3 derniers clips
        async function loadRecentContent() {
            try {
                const db = firebase.firestore();
                const recentQuery = db.collection("contents")
                    .orderBy("uploadedAt", "desc")
                    .limit(3);
                
                const snapshot = await recentQuery.get();
                
                recentContent.innerHTML = '';
                
                if (snapshot.empty) {
                    recentContent.innerHTML = '<p class="no-content">Aucun clip disponible pour le moment.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        addContentCard(doc.id, doc.data(), recentContent);
                    });
                }
            } catch (error) {
                console.error('Erreur lors du chargement des derniers clips:', error);
                recentContent.innerHTML = '<p class="error">Erreur lors du chargement des derniers clips.</p>';
            }
        }
        
        // Charger les contenus populaires
        async function loadPopularContent() {
            try {
                const db = firebase.firestore();
                const popularQuery = db.collection("contents")
                    .orderBy("views", "desc")
                    .limit(6);
                
                const snapshot = await popularQuery.get();
                
                popularContent.innerHTML = '';
                
                if (snapshot.empty) {
                    popularContent.innerHTML = '<p class="no-content">Aucun contenu populaire disponible.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        addContentCard(doc.id, doc.data(), popularContent);
                    });
                }
            } catch (error) {
                console.error('Erreur lors du chargement des contenus populaires:', error);
                popularContent.innerHTML = '<p class="error">Erreur lors du chargement des contenus populaires.</p>';
            }
        }
        
        // Charger les contenus en direct
        async function loadLiveContent() {
            try {
                const db = firebase.firestore();
                const liveQuery = db.collection("contents")
                    .where("isLive", "==", true)
                    .orderBy("uploadedAt", "desc")
                    .limit(3);
                
                const snapshot = await liveQuery.get();
                
                liveContent.innerHTML = '';
                
                if (snapshot.empty) {
                    liveContent.innerHTML = '<p class="no-content">Aucun √©v√©nement en direct pour le moment.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        addContentCard(doc.id, doc.data(), liveContent);
                    });
                }
            } catch (error) {
                console.error('Erreur lors du chargement des contenus en direct:', error);
                liveContent.innerHTML = '<p class="error">Erreur lors du chargement des contenus en direct.</p>';
            }
        }
        
        // Ajouter une carte de contenu
        function addContentCard(id, content, container) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = id;
            
            // D√©terminer l'ic√¥ne selon le type de contenu
            let icon = 'üéµ';
            if (content.contentType === 'video') icon = 'üé¨';
            if (content.contentType === 'live') icon = 'üî¥';
            
            // Formater la date
            const date = content.uploadedAt?.toDate ? content.uploadedAt.toDate() : new Date(content.uploadedAt);
            const formattedDate = date ? date.toLocaleDateString('fr-FR') : 'Date inconnue';
            
            // Formater la taille du fichier
            const formattedSize = formatFileSize(content.fileSize);
            
            // URL de la miniature
            const thumbnailUrl = content.thumbnail || `https://via.placeholder.com/300x200/0066ff/ffffff?text=${encodeURIComponent(content.title.substring(0, 2))}`;
            
            card.innerHTML = `
                <div class="card-img-container">
                    <img src="${thumbnailUrl}" alt="${content.title}" class="card-img">
                    ${content.isLive ? '<div class="live-overlay"><div class="live-badge">LIVE</div></div>' : ''}
                </div>
                <div class="card-content">
                    <h3 class="card-title">${icon} ${content.title}</h3>
                    <p class="card-artist">üë§ ${content.artist}</p>
                    <p class="card-meta">üìÅ ${formattedSize} ‚Ä¢ üìÖ ${formattedDate}</p>
                    <div class="card-actions">
                        <button class="play-btn" data-id="${id}" data-title="${content.title}" data-artist="${content.artist}" title="Lire ce contenu">‚ñ∂</button>
                        ${content.isLive ? '<div class="live-badge-small">LIVE</div>' : ''}
                    </div>
                </div>
            `;
            container.appendChild(card);
        }
        
        // Gestion de la lecture
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('play-btn') || e.target.closest('.play-btn')) {
                e.preventDefault();
                
                const playBtn = e.target.classList.contains('play-btn') ? e.target : e.target.closest('.play-btn');
                const contentId = playBtn.getAttribute('data-id');
                const title = playBtn.getAttribute('data-title');
                const artist = playBtn.getAttribute('data-artist');
                
                playContent(contentId, title, artist);
            }
        });
        
        // Fonction pour jouer un contenu
        function playContent(contentId, title, artist) {
            // V√©rifier si l'utilisateur est connect√©
            const user = firebase.auth().currentUser;
            if (!user) {
                if (confirm('Vous devez √™tre connect√© pour √©couter ce contenu. Voulez-vous vous connecter ?')) {
                    window.location.href = 'login.html';
                    return;
                }
                return;
            }
            
            // Mettre √† jour le player
            const playerTitle = document.querySelector('.player-title');
            const playerArtist = document.querySelector('.player-artist');
            const playerImg = document.querySelector('.player-img');
            
            if (playerTitle && playerArtist) {
                playerTitle.textContent = title;
                playerArtist.textContent = artist;
                playerImg.src = `https://via.placeholder.com/80x80/0066ff/ffffff?text=${encodeURIComponent(title.substring(0, 2))}`;
            }
            
            // Rediriger vers la page de lecture
            window.location.href = `player.html?id=${contentId}`;
        }
        
        // Barre de recherche
        document.querySelector('.search-bar button').addEventListener('click', () => {
            const searchTerm = document.querySelector('.search-bar input').value;
            if (searchTerm) {
                window.location.href = `search.html?q=${encodeURIComponent(searchTerm)}`;
            }
        });
        
        // Gestion des onglets
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabType = tab.getAttribute('data-tab');
                console.log(`Onglet s√©lectionn√©: ${tabType}`);
                
                // Dans une version future, vous pourriez charger du contenu dynamique
                // selon l'onglet s√©lectionn√©
            });
        });
        
        // Barre de progression
        document.querySelector('.progress').addEventListener('click', (e) => {
            const percent = (e.offsetX / e.target.offsetWidth) * 100;
            document.querySelector('.progress-bar').style.width = `${percent}%`;
        });
        
        // Fonction utilitaire pour formater la taille des fichiers
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>